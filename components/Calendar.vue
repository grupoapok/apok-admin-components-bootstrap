<template>
  <div class="calendar-container flex flex-grow-1">
    <b-form-input type="date" :state="state" :value="value" class="w-100 d-block d-sm-none"/>
    <b-form-input
      :state="state"
      :value="formattedValue"
      type="text"
      class="w-100 d-none d-sm-block"
      readonly
      :disabled="readonly"
      @focus.native="showCalendar"
      @keyup.esc.native="show = false"
    />
    <div :class="['calendar-popup', show && 'd-block']">
      <button type="button" class="close mr-2" aria-label="Close" @click="show = false">
        <span aria-hidden="true">&times;</span>
      </button>
      <table class="table">
        <thead>
          <tr>
            <th colspan="7">
              <div class="d-flex flex-row align-items-center">
                <a class="month_nav" @click="addMonth(-1)">
                  <icon icon="angle-left"></icon>
                </a>
                <div class="d-flex flex-row flex-grow-1" v-if="canSelectMonth || canSelectYear">
                  <div class="selector">
                    <b-select
                      v-if="canSelectMonth"
                      class="monthSelector"
                      :options="monthsOptions"
                      :value="startDate.month()"
                      @change="changeMonth"
                    />
                    <b-input
                      class="text-right font-weight-bold"
                      readonly
                      plaintext
                      :value="$t(monthsNames[startDate.month()])"
                      v-else
                    ></b-input>
                  </div>

                  <div class="selector">
                    <b-select
                      :options="yearsOptions"
                      v-if="canSelectYear"
                      :value="startDate.year()"
                      @change="changeYear"
                    />
                    <b-input
                      class="text-left font-weight-bold"
                      readonly
                      plaintext
                      :value="startDate.format('YYYY')"
                      v-else
                    ></b-input>
                  </div>
                </div>
                <div
                  class="text-center flex-grow-1"
                  v-else
                >{{ monthsNames[startDate.month()] | translate }} {{ startDate.format('YYYY') }}</div>
                <a class="month_nav text-right" @click="addMonth(1)">
                  <icon icon="angle-right"></icon>
                </a>
              </div>
            </th>
          </tr>
          <tr class="compact">
            <th class="text-center" v-for="(d,i) in daysNames" :key="`dn_${i}`">{{ d | translate }}</th>
          </tr>
        </thead>
        <tbody>
          <tr v-for="(w, i) in dates" :key="`sem_${i}`" class="compact">
            <td
              v-for="(d,j) in w"
              :key="`dia_${i}_${j}`"
              :class="['text-center day', d.format(format) === value && 'active']"
              @click="selectDate(d)"
            >{{ d.format("DD") }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</template>

<script>
import moment from "moment";
import Icon from "./Icon";

export default {
  name: "Calendar",
  components: { Icon },
  data() {
    return {
      internalStartDate: "",
      show: false
    };
  },
  props: {
    value: String,
    readonly: Boolean,
    state: {
      type: String,
      default: null
    },
    activeColor: {
      type: String,
      default: "rgba(0, 123, 255, 0.25)"
    },
    canSelectYear: {
      type: Boolean,
      default: true
    },
    canSelectMonth: {
      type: Boolean,
      default: true
    },
    format: {
      type: String,
      default() {
        return "YYYY-MM-DD";
      }
    },
    displayFormat: {
      type: String,
      default() {
        return "DD/MM/YYYY";
      }
    },
    daysNames: {
      type: Array,
      default() {
        return [
          "calendar.days.domingo",
          "calendar.days.lunes",
          "calendar.days.martes",
          "calendar.days.miercoles",
          "calendar.days.jueves",
          "calendar.days.viernes",
          "calendar.days.sabado"
        ];
      }
    },
    monthsNames: {
      type: Array,
      default() {
        return [
          "calendar.months.enero",
          "calendar.months.febrero",
          "calendar.months.marzo",
          "calendar.months.abril",
          "calendar.months.mayo",
          "calendar.months.junio",
          "calendar.months.julio",
          "calendar.months.agosto",
          "calendar.months.septiembre",
          "calendar.months.octubre",
          "calendar.months.noviembre",
          "calendar.months.diciembre"
        ];
      }
    }
  },
  computed: {
    formattedValue() {
      if (this.value) {
        return moment(this.value).format(this.displayFormat);
      }
      return null;
    },
    hoverAndActiveDateStyle() {
      return {
        backgroundColor: this.activeColor
      };
    },
    monthsOptions() {
      return this.monthsNames.map((m, i) => ({ value: i, text: this.$t(m) }));
    },
    yearsOptions() {
      const currentYear = moment(this.internalStartDate).year();
      let startYear = currentYear - 100;
      const years = [];
      while (startYear <= currentYear) {
        years.push(startYear);
        startYear += 1;
      }
      return years;
    },
    dates() {
      const month = [];
      let start = moment(this.startDate)
        .day(0)
        .unix();
      const end = moment(this.endDate)
        .day(6)
        .unix();
      while (start < end) {
        const week = [];
        for (let d = 0; d < 7; d += 1) {
          week.push(moment(start * 1000));
          start += 86400;
        }
        month.push(week);
      }
      return month;
    },
    startDate() {
      return moment(this.internalStartDate)
        .set("date", 1)
        .set("hour", 0)
        .set("minute", 0)
        .set("second", 0)
        .set("millisecond", 0);
    },
    endDate() {
      return moment(this.startDate)
        .add(1, "months")
        .subtract(1, "days");
    }
  },
  watch: {
    value: {
      handler: "updateInternalStartDate",
      immediate: true
    }
  },
  methods: {
    enableHoverAndActiveClass(e) {
      const tableCell = e.target;
      //tableCell.style.backgroundColor = this.activeColor;
    },
    disableHoverAndActiveClass(e) {
      const tableCell = e.target;
      if (!tableCell.classList.contains("active")) {
        //tableCell.style.backgroundColor = "";
      }
    },
    // formatToDisplay(value) {
    //   return moment(value).format(this.displayFormat);
    // },
    showCalendar() {
      this.show = !this.readonly && true;
    },
    updateInternalStartDate(val) {
      if (val) {
        this.internalStartDate = val;
      } else {
        this.internalStartDate = new Date();
      }
    },
    selectDate(date) {
      this.$emit("input", date.format(this.format));
      this.show = false;
    },
    addMonth(n) {
      this.updateInternalStartDate(
        moment(this.internalStartDate)
          .add(n, "months")
          .format(this.format)
      );
    },
    changeMonth(n) {
      this.updateInternalStartDate(
        moment(this.internalStartDate)
          .month(n)
          .format(this.format)
      );
    },
    changeYear(n) {
      this.updateInternalStartDate(
        moment(this.internalStartDate)
          .year(n)
          .format(this.format)
      );
    }
  }
};
</script>

<style scoped lang="scss">
.calendar-container {
  position: relative;
  .monthSelector {
    text-align-last: right;
    option {
      direction: rtl;
    }
  }
  input {
    background: $input-bg !important;
  }
  .close {
    outline: none !important;
  }
  .calendar-popup {
    background: $input-bg !important;
    display: none;
    position: absolute;
    top: calc(100% - 1px);
    left: 0;
    width: 100%;
    z-index: 999;
    border: $input-border-width solid $input-border-color;
    border-bottom-left-radius: $input-border-radius;
    border-bottom-right-radius: $input-border-radius;
    .table {
      margin-bottom: 0;
      thead {
        &:first-child {
          th {
            border-top: none;
            .selector {
              margin-left: 1em;
              margin-right: 0;
              width: calc(50% - 2em);
              & + .selector {
                margin-left: 0.5em;
                margin-right: 1em;
              }
            }
          }
        }
      }
      tr {
        &.compact {
          th,
          td {
            padding: 0.25rem;
          }
        }
        th {
          a.month_nav {
            cursor: pointer;
          }
        }
        td {
          cursor: pointer;
          background: white;
          &:hover {
            background: $primary;
            color: color-yiq($primary);
          }
          &.active {
            background: $primary;
            color: color-yiq($primary);
          }
        }
      }
    }
  }
}
</style>
